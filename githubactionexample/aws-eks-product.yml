# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: DeploymentProduct

on:
  push:
    branches: [ "main" ]
    paths:
      - 'manage_product_service/**'
      - 'Infras/prod/product-template-deployment.yaml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'manage_product_service/**'

env: 
  TAG_VER: ${{ github.run_number }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  DB_USER_HOST: ${{ secrets.DB_USER_HOST }}
  DB_USER_PORT: ${{ secrets.DB_USER_PORT }}
  DB_USER_USERNAME: ${{ secrets.DB_USER_USERNAME }}
  DB_USER_PASSWORD: ${{ secrets.DB_USER_PASSWORD }}

  LABGIT_TOKEN: ${{ secrets.LABGIT_TOKEN }}
  LABGIT_ORIGIN: ${{ secrets.LABGIT_ORIGIN }}
  LABGIT_PATH: ${{ secrets.LABGIT_PATH }}
  LABGIT_REPO_PRODUCT: ${{ secrets.LABGIT_REPO_PRODUCT }}
  LABGIT_USER: ${{ secrets.LABGIT_USER }}
  LABGIT_EMAIL: ${{ secrets.LABGIT_EMAIL }}

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1

    - name: Docker Login
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

    - name: PRODUCT Build container image 
      working-directory: ./product_service
      run: docker build -t devopstest/lotto-product-service:$TAG_VER -f dockerfile .

    - name: PRODUCT Push image to Docker Hub
      run: docker push devopstest/lotto-product-service:$TAG_VER

    - name: Update kube Config
      run: aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region ap-southeast-1

    # มีการ push เข้า gitlab ที่เป็นตั้ง server เอง
    - name: Configure YAML For kube and apply
      # working-directory: ./Infras/prod
      run: |
        envsubst < product-template-deployment.yaml > product-deploy.yaml
        kubectl apply -f product-deploy.yaml
        git config --global user.email "$LABGIT_EMAIL"
        git config --global user.name "$LABGIT_USER"
        git clone https://oauth2:$LABGIT_TOKEN@$LABGIT_ORIGIN/$LABGIT_PATH/$LABGIT_REPO_PRODUCT.git
        cp product-deploy.yaml $LABGIT_REPO_PRODUCT/product-deploy.yaml
        cd $LABGIT_REPO_PRODUCT
        git remote add $LABGIT_REPO_PRODUCT https://oauth2:$LABGIT_TOKEN@$LABGIT_ORIGIN/$LABGIT_PATH/$LABGIT_REPO_PRODUCT.git
        git remote update
        git add product-deploy.yaml
        git commit -am "new version service product $TAG_VER"
        git push origin main